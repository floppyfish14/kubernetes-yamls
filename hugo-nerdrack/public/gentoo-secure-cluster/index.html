    <!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> Gentoo Secure Cluster &middot; Nerdrack as a Solution </title>
    
    <link rel="stylesheet" type="text/css" href="https://nerdrack.com//css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="https://nerdrack.com//css/lightGallery.css" />
    <link rel="stylesheet" type="text/css" href="https://nerdrack.com//css/images.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://nerdrack.com/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="https://nerdrack.com/favicon.ico">
    
    <link href="" rel="alternate" type="application/rss+xml" title="Nerdrack as a Solution" />
    
    <script src="https://nerdrack.com//js/jquery.min.js"></script>
    <script src="https://nerdrack.com//js/main.min.js"></script>
</head>

    <body>
        <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        "  style="background-image: url(/images/background-cover.jpg)" >
    <div class="panel-main">
        <div id="particles-js"></div>
         
        <script src="https://nerdrack.com//js/particles.min.js"></script>
        <script src="https://nerdrack.com//js/particles.js"></script>
        <script src="https://nerdrack.com//js/ResizeSensor.js"></script>
        <script src="https://nerdrack.com//js/ElementQueries.js"></script>
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="https://nerdrack.com//" title="link to homepage for Nerdrack as a Solution"> <img src="https://nerdrack.com/images/logo-1.png" width="400" alt="Nerdrack as a Solution logo" class="panel-cover__logo logo" /> </a> 
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  Let the nerds figure it out for you.  </p>
                <hr class="panel-cover__divider panel-cover__divider--secondary" />
                <div class="navigation-wrapper">
                    <nav class="cover-navigation cover-navigation--primary">
                        <ul class="navigation">
                            <li class="navigation__item"><a href="https://nerdrack.com/#blog" title="link to Nerdrack as a Solution blog" class="blog-button">Blog</a> </li></br>
                            
                            
                       </ul>
                    </nav> <nav class="cover-navigation navigation--social">
      
        <ul class="navigation">
        
        <li class="navigation__item">
            <a href="mailto:mfish551.mf@gmail.com" title=""> <i class="fa fa-envelope"></i>
              <span class="label">email</span></a>
        </li>
        
        <li class="navigation__item">
            <a href="#!" title="test"> <i class="fa fa-linkedin"></i>
              <span class="label">linkedin</span></a>
        </li>
        
        <li class="navigation__item">
            <a href="https://git.nerdrack.com" title="we host our own repos"> <i class="fa fa-git"></i>
              <span class="label">gitea</span></a>
        </li>
        
        </ul>
      
</nav>
 </div>
            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
        <div class="panel-main">
            <div id="particles-js"></div>
            
            <script src="https://nerdrack.com//js/particles.min.js"></script>
            <script src="https://nerdrack.com//js/particles.js"></script>
            <script src="https://nerdrack.com//js/ResizeSensor.js"></script>
            <script src="https://nerdrack.com//js/ElementQueries.js"></script>
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="https://nerdrack.com//" title="link to homepage for Nerdrack as a Solution"> <img src="https://nerdrack.com/images/logo-1.png" width="200" alt="Nerdrack as a Solution logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="https://nerdrack.com//"  title="link to homepage for Nerdrack as a Solution">Nerdrack as a Solution</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  This site is built using <a href="http://gohugo.io">hugo</a> and the theme is built by <a href="http://fredrikloch.me">Fredrik</a> if you enjoy it, it is available at <a href="https://github.com/SenjinDarashiva/hugo-uno">github</a>  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                                <li class="navigation__item"><a href="https://nerdrack.com//#blog" title="link to Nerdrack as a Solution blog" class="blog-button">Blog</a> </li></br>
                                
                                
                           </ul>
                        </nav> <nav class="cover-navigation navigation--social">
      
        <ul class="navigation">
        
        <li class="navigation__item">
            <a href="mailto:mfish551.mf@gmail.com" title=""> <i class="fa fa-envelope"></i>
              <span class="label">email</span></a>
        </li>
        
        <li class="navigation__item">
            <a href="#!" title="test"> <i class="fa fa-linkedin"></i>
              <span class="label">linkedin</span></a>
        </li>
        
        <li class="navigation__item">
            <a href="https://git.nerdrack.com" title="we host our own repos"> <i class="fa fa-git"></i>
              <span class="label">gitea</span></a>
        </li>
        
        </ul>
      
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

        <div class="content-wrapper">
            <div class="content-wrapper__inner">
                <div class="post">
                    <h1>Gentoo Secure Cluster</h1>
                    <span class="post-date">Thu, Mar 28, 2019</span>
                    

<h2 id="1-download-miminal-gentoo-iso-https-www-gentoo-org-downloads">1) Download miminal <a href="https://www.gentoo.org/downloads/">gentoo iso</a></h2>

<h2 id="2-dd-image-to-a-usb">2) DD image to a usb</h2>

<p>This command will overwrite data that is on your usb if you have not formatted it.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo dd <span style="color:#6ab825;font-weight:bold">if</span>=install-amd64-minimal.iso <span style="color:#40ffff">of</span>=/dev/sdX <span style="color:#40ffff">conv</span>=sync,noerror <span style="color:#40ffff">bs</span>=<span style="color:#3677a9">1024</span></code></pre></div>
<p><em>Note that /dev/sdX refers to the block designation of the usb. Yours will be different</em></p>

<h2 id="3-install-gentoo">3) Install gentoo</h2>

<p>Use the usb to boot into your intended computer. Typically, BIOSs have a boot menu option enabled which you can access by rapidly pressing the <f12> key at bootup. After you&rsquo;ve enter your boot menu, select the option to boot from USB.</p>

<p>This screen will appear after you&rsquo;ve selected the image to boot.
<em>add a gentoo boot image</em></p>

<p>Now you should configure your networking!</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">add code for networking once you&#39;ve figured it out</pre></div>
<h3 id="partition-the-hard-drive">Partition the Hard Drive</h3>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~# gdisk /dev/sdX
GPT fdisk (gdisk) version 1.0.3
... additional output suppressed ...
Command (? for help): n
Partition number (1-128, default 1): 1
First sector: [Enter]
Last sector: 100Mi
Hex code or GUID: ef00
Command (? for help): n
Partition number: 2
First sector: [Enter]
Last sector: [Enter]
Hex code or GUID: 8e00
Command (? for help): w

Final checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING PARTITIONS!!

Do you want to proceed? (Y/N): y
OK; writing new GUID partition table (GPT) to /dev/sdX.
The operation has completed successfully.</pre></div>
<p>The next step will format the partition using LUKS (Linux Unified Key Setup). The whole /dev/sdX2 partition will be encrypted with a high entropy key, the <em>master key</em>. This key is then encrypted using between one and eight <em>user</em> keys. The user keys are pre-processed by <a href="Some link">PBKDF2</a>. Luks does not care about the symmetric encryption method used, as long as it is supported by <a href="some link">dm-crypt</a> it will use whatever encryption method you supply. To the currently supported encrypt and hash algorithms use:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~# cat /proc/crypto</pre></div>
<p>Next we will encrypt the newly made LVM partition.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~# cryptsetup --cipher serpent-xts-plain64 --key-size 512 --hash whirlpool luksFormat /dev/sdX2

WARNING!
========
This will overwrite data on /dev/sdX2 irrevocably.

Are you sure? (Type uppercase yes): YES
Enter passphrase: &lt;your passphrase&gt;
Verify passphrase: &lt;your passphrase&gt;
livecd ~#</pre></div>
<p>Check that the formatting worked:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~# cryptsetup luksDump /dev/sdX2</pre></div>
<p><strong>If the LUKS header get damaged, your encrypted data will be lost forever. You should backup your header.</strong></p>

<h2 id="structure-your-lvm">Structure your LVM</h2>

<p>Talk about PV
Talk about PE
Talk about VG
Talk about LV</p>

<p>livecd ~# cryptsetup luksOpen /dev/sdx3 gentoo
Enter passphrase for /dev/sdX2: <your passphrase></p>

<p>livecd ~# pvcreate /dev/mapper/gentoo
<em>If you see a warning that says:</em></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">/run/lvm/lvmetad.socket: connect failed: No such file or directory
WARNING: Failed to connect to lvmetad. Falling back to internal scanning.</pre></div>
<p><em>it may be ignored.</em></p>

<p>Now we create a volume group for the PV.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~# vgcreate &lt;vgname&gt; /dev/mapper/gentoo</pre></div>
<p>Create a swap partition.
Size your Swap according to the size of your RAM. You can see your total RAM size using:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~# grep MemTotal /proc/meminfo</pre></div>
<p>Create the logical volumes.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~# lvcreate --size 10G --name swap &lt;vgname&gt;
livecd ~# lvcreate --size 50G --name root &lt;vgname&gt;
livecd ~# lvcreate --extents 95%FREE --name home &lt;vgname&gt;
livecd ~# pvdisplay
livecd ~# vgdisplay
livecd ~# lvdisplay</pre></div>
<p>Now active your voluem group so that the logical volumes become available as block devices for formatting:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~# ls /dev/mapper
control gentoo &lt;vgname&gt;-home &lt;vgname&gt;-root &lt;vgname&gt;-swap
livecd ~# mkswap -L &#34;swap&#34; /dev/mapper/&lt;vgname&gt;-swap
livecd ~# mkfs.ext4 -L &#34;root&#34; /dev/mapper/&lt;vgname&gt;-root
livecd ~# mkfs.ext4 -L &#34;home&#34; -m 0 /dev/mapper/&lt;vgname&gt;-home
livecd ~# swapon -v /dev/mapper/&lt;vgname&gt;-swap
livecd ~# mount -v -t ext4 /dev/mapper/&lt;vgname&gt;-root /mnt/gentoo</pre></div>
<h3 id="create-and-mount-needed-directories">Create and Mount Needed Directories</h3>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~# mkdir -v /mnt/gentoo/{home,boot,boot/efi}
livecd ~# mount -v -t ext4 /dev/mapper/&lt;vgname&gt;-home /mnt/gentoo/home
livecd ~# umount -v /tmp/efiboot</pre></div>
<p>Now we can setup our server with a stage3 tarball.
<em>We will set a variable inside of bash to pull down the most recent realease from gentoo</em></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~# cd /mnt/gentoo
livecd /mnt/gentoo # DATE=$(curl http://distfiles.gentoo.org/releases/amd64/autobuilds/latest-stage3-amd64.txt | grep .xz| cut -d&#39;/&#39; -f1)
livecd /mnt/gentoo # wget -c http://distfiles.gentoo.org/releases/amd64/autobuilds/$DATE/stage3-amd64-$DATE.tar.xz
livecd /mnt/gentoo # tar -xvjpf stage3-amd64.*.tar.xz --xattrs-include=&#39;*.*&#39; --numeric-owner
livecd /mnt/gentoo # ls</pre></div>
<p>You should see the base gentoo files have populated inside of /mnt/gentoo.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd /mnt/gentoo # rm -v -f stage3-amd64-*
livecd /mnt/gentoo # cd ~</pre></div>
<h2 id="gentoo-portage-ebuilds-and-emerge">Gentoo, Portage, Ebuilds and emerge</h2>

<p><em>Talk about these things in depth.</em></p>

<h2 id="configure-etc-porttage-make-conf">Configure /etc/porttage/make.conf</h2>

<p>Use your preferred editor to configure your system.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~ # vi /mnt/gentoo/root/.bashrc

export NUMCPUS=$(nproc)
export NUMCPUSPLUSONE=$(( NUMCPUS + 1 ))
export MAKEOPTS=&#34;-j${NUMCPUSPLUSONE} -l${NUMCPUS}&#34;
export EMERGE_DEFAULT_OPTS=&#34;--jobs=${NUMCPUSPLUSONE} --load-average=${NUMCPUS}&#34;</pre></div>
<p>Save and exit.</p>

<p><em>Talk about parrallel compiling and what to do if it doesn&rsquo;t work</em></p>

<p>Ensure the .bashrc file is picked up by root&rsquo;s login shell; copy it to the default .bash_profile</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~ # cp -v /mnt/gentoo/etc/skel/.bash_profile /mnt/gentoo/root/</pre></div>
<p>Edit /mnt/gentoo/etc/portage/make.conf to read:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"># Build setup as of &lt;add current date&gt;

# C and C++ compiler options for GCC.
CFLAGS=&#34;-march=native -O2 -pipe&#34;
CXXFLAGS=&#34;${CFLAGS}&#34;

# Note: MAKEOPTS and EMERGE_DEFAULT_OPTS are set in .bashrc

# Only free software, please.
ACCEPT_LICENSE=&#34;-* @FREE CC-Sampling-Plus-1.0&#34;

# WARNING: Changing your CHOST is not something that should be done lightly.
# Please consult http://www.gentoo.org/doc/en/change-chost.xml before changing.
CHOST=&#34;x86_64-pc-linux-gnu&#34;

# Use the &#39;stable&#39; branch - &#39;testing&#39; no longer required for Gnome 3.
# NB, amd64 is correct for both Intel and AMD 64-bit CPUs
ACCEPT_KEYWORDS=&#34;amd64&#34;

# Additional USE flags supplementary to those specified by the current profile.
USE=&#34;&#34;
CPU_FLAGS_X86=&#34;mmx mmxext sse sse2&#34;

# Important Portage directories.
PORTDIR=&#34;/usr/portage&#34;
DISTDIR=&#34;${PORTDIR}/distfiles&#34;
PKGDIR=&#34;${PORTDIR}/packages&#34;

# This sets the language of build output to English.
# Please keep this setting intact when reporting bugs.
LC_MESSAGES=C

# Turn on logging - see http://gentoo-en.vfose.ru/wiki/Gentoo_maintenance.
PORTAGE_ELOG_CLASSES=&#34;info warn error log qa&#34;
# Echo messages after emerge, also save to /var/log/portage/elog
PORTAGE_ELOG_SYSTEM=&#34;echo save&#34;

# Ensure elogs saved in category subdirectories.
# Build binary packages as a byproduct of each emerge, a useful backup.
FEATURES=&#34;split-elog buildpkg&#34;

# Settings for X11
VIDEO_CARDS=&#34;intel i965&#34;
INPUT_DEVICES=&#34;libinput&#34;</pre></div>
<p><em>Talk about different values for VIDEO_CARDS</em></p>

<h2 id="build-your-systemd-gentoo-base-minus-kernel">Build your systemd Gentoo Base (Minus Kernel)</h2>

<p>Select the appropriate server URI&rsquo;s for Portage to search through when looking for source tarballs.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~ # mirror select -i -o &gt;&gt; /mnt/gentoo/etc/portage/make.conf
&lt;select all mirrors in your region&gt;
livecd ~ # tail /mnt/gentoo/etc/portage/make.conf
&lt;check that the appropriate enteries were written to make.conf&gt;
livecd ~ # ls -d /mnt/gentoo/var/db/pkg/sys-apps/portage-*
/mnt/gentoo/var/db/pkg/sys-apps/portage-2.3.62</pre></div>
<p>Ensure your version of portage is suffienctly recent. At the time of writing (29Mar19), the portage version was 2.3.62.</p>

<p>Next, setup a gentoo.conf file:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~ # mkdir -p -v /mnt/gentoo/etc/portage/repos.conf
livecd ~ # cp -v /mnt/gentoo/usr/share/portage/config/repos.conf /mnt/gentoo/etc/portage/repos.conf/gentoo.conf
livecd ~ # vi /mnt/gentoo/etc/portage/repos.conf/gentoo.conf</pre></div>
<p>/mnt/gentoo/etc/portage/repos.conf/gentoo.conf should read:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">[DEFAULT]
main-repo = gentoo
sync-allow-hardlinks = yes

[gentoo]
location = /usr/portage
sync-type = webrsync
#sync-type = rsync
sync-uri = rsync://rsync.gentoo.org/gentoo-portage
sync-webrsync-verify-signature = true
auto-sync = yes

sync-rsync-verify-jobs = 1
sync-rsync-verify-metamanifest = yes
sync-rsync-verify-max-age = 24
sync-openpgp-key-path = /usr/share/openpgp-keys/gentoo-release.asc
sync-openpgp-key-refresh-retry-count = 40
sync-openpgp-key-refresh-retry-overall-timeout = 1200
sync-openpgp-key-refresh-retry-delay-exp-base = 2
sync-openpgp-key-refresh-retry-delay-max = 60
sync-openpgp-key-refresh-retry-delay-mult = 4</pre></div>
<p><em>Talk about settings and their meanings</em></p>

<p>Ensure DNS is carried over to our chroot envrionment by issuing:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~ # cp -v -L /etc/resolv.conf /mnt/gentoo/etc/</pre></div>
<p><strong>If installing via wifi</strong></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~ # cp -v /etc/wpa.conf /mnt/gentoo/etc/</pre></div>
<p>Mount some needed system directories for the chroot environment.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~ # mount -v -t proc none /mnt/gentoo/proc
livecd ~ # mount -v --rbind /sys /mnt/gento/sys
livecd ~ # mount -v --rbind /dev /mnt/gentoo/dev</pre></div>
<p>Now we ensure that /sys and /dev are bind mounted as slaves. <em>Explain why</em></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~ # mount -v --make-rslave /mnt/gentoo/sys
livecd ~ # mount -v --make-rslave /mnt/gentoo/dev</pre></div>
<h2 id="enter-chroot">Enter chroot</h2>

<p><em>Give some background and overview of chroot and what we will be doing</em></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~ # chroot /mnt/gentoo /bin/bash
livecd ~ # source /etc/profile
livecd ~ # export PS1=&#34;(chroot) $PS1&#34;</pre></div>
<p><em>Explain difference between ssh and physical connect chroot</em></p>

<h2 id="install-an-up-to-date-portage-tree">Install an Up-to-Date Portage Tree</h2>

<p><em>Overview process of creating portage tree</em></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # emaint sync --auto
&gt;&gt;&gt; Syncing repository &#39;gentoo&#39; into &#39;/usr/portage&#39;...
 * Using keys from /usr/share/openpgp-keys/gentoo-release.asc
 * Refreshing keys from keyserver ...                                    [ ok ]
Fetching most recent snapshot ...
Trying to retrieve YYYYMMDD snapshot from &lt;a_local_mirror&gt; ...
Fetching file portage-YYYYMMDD.tar.xz.md5sum ...
Fetching file portage-YYYYMMDD.tar.xz.gpgsig ...
Fetching file portage-YYYYMMDD.tar.xz ...
Checking digest ...
Checking signature ...
gpg: Signature made &lt;a_timestamp&gt;
gpg:                using RSA key &lt;a_key_id&gt;
gpg: Good signature from &#34;Gentoo ebuild repository signing key (Automated Signing Key) &lt;infrastructure@gentoo.org&gt;&#34; [unknown]
gpg:                 aka &#34;Gentoo Portage Snapshot Signing Key (Automated Signing Key)&#34; [unknown]
gpg: WARNING: Using untrusted key!
Getting snapshot timestamp ...
Syncing local tree ...
... additional output suppressed ...
Action: sync for repo: gentoo, returned code = 0</pre></div>
<p>You should receive a code of 0 after the sync has completed. <em>Explain what just happened, and why the keys were &lsquo;untrusted&rsquo;.</em>
Ignore the prompt to read news articles for now.</p>

<p>Now that we have a base under our feet, switch to the more effienct rsync protocol by issuing:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # nano -w /etc/portage/repos.conf/gentoo.conf
#sync-type = webrsync
sync-type = rsync
(chroot) livecd / # emaint sync --auto
&gt;&gt;&gt; Syncing repository &#39;gentoo&#39; into &#39;/usr/portage&#39;...
 * Using keys from /usr/share/openpgp-keys/gentoo-release.asc
 * Refreshing keys from keyserver ...                                    [ ok ]
&gt;&gt;&gt; Starting rsync with rsync://&lt;ip_addr&gt;/gentoo-portage...
... additional output suppressed ...
Action: sync for repo: gentoo, returned code = 0</pre></div>
<p><em>Explain reasoning behind -w flag passed to nano</em>
<em>Explain how rsync works</em></p>

<p>Our next step is to ensure portage itself is up to date now that we have a known-valid current Portage ebuild.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # emerge --ask --verbose --oneshot portage
... additional output suppressed ...
Would you like to merge these packages? [Yes/No] &lt;press y, then press Enter&gt;
... additional output suppressed ...</pre></div>
<p><em>Talk about what&rsquo;s going on underneath the hood</em></p>

<h3 id="read-the-news">Read the news</h3>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # eselect news list
(chroot) livecd / # eselect news read N &lt;replace N with a number from the last command&gt;</pre></div>
<p><strong>OR</strong></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # eslect news purge</pre></div>
<p>Personal preference is key here. Just remember, those informed stay wise.</p>

<h3 id="ensure-a-base-profile-is-set">Ensure a Base Profile is set</h3>

<p><em>Explain profiles and what they do</em></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # eselect profile list | less
(chroot) livecd / # eselect profile set N &lt;ensure N corresponds to &#34;default/linux/amd64/17.0&#34;&gt;</pre></div>
<h3 id="set-timezone-and-locale">Set Timezone and Locale</h3>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # ls /usr/share/zoneinfo</pre></div>
<p>Choose the appropriate location, for example to set Los Angeles in the US:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # echo &#34;America/Los_Angeles&#34; &gt; /etc/timezone</pre></div>
<p>Now we reconfigure the sys-libs/timezone-data package; this will pull the value from /etc/timezone and reflect that value in /etc/localtime. This is necessary for the system C library.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # emerge -v --config sys-libs/timezone-data</pre></div>
<p>If the appropriate locale is listed for you in the file, simply uncomment it. Otherwise, you will need to <em>append</em> the locale to the end of the file. For example:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # nano -w /etc/locale.gen
en_GB ISO-8859-1
en_GB.UTF-8 UTF-8</pre></div>
<p>Save and exit. <em>Explain why you should add a UTF-8 entry</em>
<em>Give a link for more information on locales</em></p>

<p>Now we must generate our locales. Issue:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # locale-gen</pre></div>
<p>This takes the values from /etc/local.gen and uses them to create the locales.</p>

<p><em>To see a list of currently installed locales</em></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # eslect locale list
  [1]   C
  [2]   en_GB
  [3]   en_GB.iso88591
  [4]   en_GB.utf8
  [5]   POSIX
  [ ]   (free form)</pre></div>
<p>If following this guide using <strong>ssh/screen</strong>, issue:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # eselect locale set &#34;C&#34;</pre></div>
<p>because other setups can cause issues. We will switch the locale later on.</p>

<p>Now reload your environment:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # env-update &amp;&amp; source /etc/profile &amp;&amp; export PS1=&#34;(chroot) $PS1&#34;</pre></div>
<h2 id="setting-up-post-boot-keymap">Setting Up (Post-Boot) Keymap</h2>

<p><em>Explain difference between initramfs keymap and post-boot keymap and why we set them</em>
To search for qwerty keyboard mappings, issue:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # ls /usr/share/keymaps/i386/qwerty</pre></div>
<p>Choose your keymapping and set it using:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # nano -w /etc/conf.d/keymaps
keymap=&#34;ru&#34;</pre></div>
<p>Save and exit. This would set a Russian keymapping. <strong>Set the appropriate keymapping for you</strong></p>

<h3 id="set-processor-specific-features-optional">Set Processor-Specific Features (Optional)</h3>

<p>Currently we have default CPU_FLAGS_x86 set. If you would like to use the specific features of your CPU, execute the following:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # emerge --verbose --oneshot app-portage/cpuid2cpuflags
(chroot) livecd / # cpuid2cpuflags
(chroot) livecd / # nano -w /etc/portage/make.conf
CPU_FLAGS_X86=&#34;CPU_FLAGS_X86: aes avx avx2 fma3 mmx mmxext popcnt sse sse2 sse3 sse4_1 sse4_2 ssse3&#34;</pre></div>
<p>Your values will most likely differ. Save and exit.</p>

<h3 id="prepare-to-run-parallel-emerges">Prepare to Run Parallel emerges</h3>

<p><em>Explain why we need zzz_via_autounmask</em>
<em>Thank Sakaki for her github awesomeness</em></p>

<p>Install git since we will need it to install zzz_autounmask</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # mkdir -p -v /etc/portage/package.use
(chroot) livecd / # touch /etc/portage/package.use/zzz_via_autounmask
(chroot) livecd / # emerge --ask --verbose dev-vcs/git
... additional output suppressed ...
Would you like to merge these packages? [Yes/No] &lt;press y, then Enter&gt;
... additional output suppressed ...</pre></div>
<p><em>Write about good housekeeping and why zzz<em>autounmask starts with zzz</em></em>
<em>Write about why we created the directory</em></p>

<p>Tell portage about our directory.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # nano -w /etc/portage/repos.conf/sakaki-tools.conf
[sakaki-tools]

# Various utility ebuilds for Gentoo on EFI
# Maintainer: sakaki (sakaki@deciban.com)

location = /usr/local/portage/sakaki-tools
sync-type = git
sync-uri = https://github.com/sakaki-/sakaki-tools.git
priority = 50
auto-sync = yes</pre></div>
<p><em>Explain what we did</em></p>

<p>Pull in the ebuild repository:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # emaint sync --repo sakaki-tools
(chroot) livecd / # mkdir -p -v /etc/portage/package.mask
(chroot) livecd / # echo &#39;*/*::sakaki-tools&#39; &gt;&gt; /etc/portage/package.mask/sakaki-tools-repo</pre></div>
<p><em>explain each command</em>
<em>talk about priority and overlays and mask, unmask, read</em></p>

<p>Wildcard-mask everything from sakaki-tools</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # mkdir -p -v /etc/portage/package.mask
(chroot) livecd / # echo &#39;*/*::sakaki-tools&#39; &gt;&gt; /etc/portage/package.mask/sakaki-tools-repo</pre></div>
<p>Unmask showem to enable output from a parallel emerge</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # mkdir -p -v /etc/portage/package.unmask
(chroot) livecd / # touch /etc/portage/package.unmask/zzz_via_autounmask
(chroot) livecd / # echo &#34;app-portage/showem::sakaki-tools&#34; &gt;&gt; /etc/portage/package.unmask/showem</pre></div>
<p>All user repository ebuilds <em>must</em> specify that they are on the &lsquo;unstable&rsquo; branch (since they are not yet fully tested). Our current configuration only allows fro stable (amd64) packages; we have to specify that the sakaki-tools repo is acceptable by applying the (&lsquo;tilde&rsquo;) inside of /etc/portage/package.accept_keywords directory:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # mkdir -p -v /etc/portage/package.accept_keywords
(chroot) livecd / # touch /etc/portage/package.accept_keywords/zzz_via_autounmask
(chroot) livecd / # echo &#34;*/*::sakaki-tools ~amd64&#34; &gt;&gt; /etc/portage/package.accept_keywords/sakaki-tools-repo</pre></div>
<p>This uses a <a href="some link to atoms">qualified atom</a>. <em>explain atoms</em></p>

<p>Install the showem tools using emerege:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # emerge -av app-portage/showem
... additional output suppressed ...
Would you like to merge these packages? [Yes/No] &lt;press y, then Enter&gt;
... additional output suppressed ...</pre></div>
<h3 id="build-the-system">Build the system</h3>

<p>Now that we will begin building our system; we should open another virtual console. <em>If using ssh and screen</em>: press Ctrl-a then c to start a new console. <em>If building directly on the computer</em>: <Ctrl>-<Alt>-<f2>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">livecd ~ # chroot /mnt/gentoo /bin/bash
livecd / # source /etc/profile
livecd / # export PS1=&#34;(chroot:2) $PS1&#34;</pre></div>
<h3 id="re-build-the-system-optional-but-recommended">Re-Build the system (Optional but Recommended)</h3>

<p>In Gentoo, everything comes down to choice. If you choose to follow this portion of the <a href="http://nerdrack.com/gentoo-secure-cluster">Gentoo Secure Cluster</a>, you are ensuring the integrity of your build (to a certain point). As was discussed by Ken Thompson in his 1983 Turing Award lecture, &ldquo;Reflections on Trusting Trust&rdquo;, the use of any &lsquo;original&rsquo; binary can potentially expose all &lsquo;downstream&rsquo; code to a backdoor attack. This applies to our situtation by using the stage3 tarball provided by Gentoo; basically, by using the precompiled gcc binary for our system we are introducing a small amount of uncertainty to the security of our build. We did not compile the gcc binary ourselves, thus we cannot ensure that the compilier does not have some vulnerability built in that we don&rsquo;t know about. GCC is used to compile all of the packages on our system and these packages would then have the same vulnerability (if any) that the gcc compiler itself has. Seeing that this guide is focused on security, we recommend re-compiling your system from a stage1 tarball and building it back up to stage3; this is the focus of the current section. Seeing that Gentoo is about choice, there is no obligation to do so; and in fact, we will be providing an <a href="some link to iso">ISO</a> image for you to download and use on your hosting provider as the baseline image for your kubernetes cluster. The image will be an exact replica of the outcome of this guide, if you trust that we&rsquo;re not lying ;). For those of you that have created your own system using <em>Linux from Scratch</em> this will seem familiar; luckily, we have Portage to do all of the dirty work for us! Let&rsquo;s begin ensuring our build&rsquo;s integrity:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # cd /usr/portage/scripts
(chroot) livecd /usr/portage/scripts # ./bootstrap.sh --pretend
... additional output suppressed ...
  [[ (0/3) Locating packages ]]
* Using baselayout : &gt;=sys-apps/baselayout-2
* Using portage    : portage
* Using os-headers : &gt;=sys-kernel/linux-headers-4.14-r1
* Using binutils   : sys-devel/binutils
* Using gcc        : sys-devel/gcc
* Using gettext    : gettext
* Using libc       : virtual/libc
* Using texinfo    : sys-apps/texinfo
* Using zlib       : zlib
* Using ncurses    : ncurses
... addtional output suppressed ...
!!! CONFIG_PROTECT is empty
... addtional output suppressed ...</pre></div>
<p>Exact versions and packages shown in your output may differ. The ./bootstrap.sh script is selecting the order of packages we will need to compile to create a basic toolchain for our newly built system. The Gentoo <a href="link to gentoo FAQ">FAQ</a> suggests that you can edit your bootstrap.sh script after reviewing it. We will be doing this to change our libc version. The bootstrap script is choosing to build the <em>virtual</em> libc; however, in Portage, emerging a virtual package does not, by default, cause an already installed package that satisfies the <em>virtual</em> to be rebuilt. We want to re-build our glibc, so issue:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd /usr/portage/scripts # nano -w bootstrap.sh
&lt;Ctrl-w&gt;
Search: should never fail &lt;Enter&gt;</pre></div>
<p>Navigate to the line setting myLIBC and modify it (change &amp;&amp; to ;):</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">[[ -z ${myBASELAYOUT} ]] &amp;&amp; myBASELAYOUT=&#34;&gt;=$(portageq best_version / sys-apps/baselayout)&#34;
... additional lines suppressed ...
[[ -z ${myLIBC}       ]] ; myLIBC=&#34;$(portageq expand_virtual / virtual/libc)&#34;
[[ -z ${myTEXINFO     ]] &amp;&amp; myTEXINFO=&#34;sys-apps/texinfo&#34;
... additional lines suppressed ...</pre></div>
<p>The other two lines are a reference and <strong>are not</strong> modified. We have changed the conditional statement to a regular statement, forcing bootstrap.sh to recompile virtual/libc which causes sys-libs/glibc to be recompiled. This file is a part of the main Gentoo ebuild repository and your changes will be overwrittent the next time you sync. This is not a problem because we are only bootstrapping our system once.</p>

<p>Ensure our changes do what we want:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd /usr/portage/scripts # ./bootstrap.sh --pretend
... additional output suppressed ... 
  [[ (0/3) Locating packages ]]
* Using baselayout : &gt;=sys-apps/baselayout-2
* Using portage    : portage
* Using os-headers : &gt;=sys-kernel/linux-headers-4.14-r1
* Using binutils   : sys-devel/binutils
* Using gcc        : sys-devel/gcc
* Using gettext    : gettext
* Using libc       : sys-libs/glibc:2.2
* Using texinfo    : sys-apps/texinfo
* Using zlib       : zlib
* Using ncurses    : ncurses
... addtional output suppressed ... 
!!! CONFIG_PROTECT is empty
... addtional output suppressed ... </pre></div>
<p>Now we should handle the fact that CONFIG_PROTECT is empty; this is telling us that our bootstrap process will <em>not</em> preserve any configuration files you may have modified if any of the packages to be installed try to overwrite them. So far, we have modified two configuration files (that will be overwritten). To remedy this, we will be using the supplied qfile utility to check if either is affected.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd /usr/portage/scripts # qfile /etc/locale.gen /etc/conf.d/keymaps
sys-apps/openrc (/etc/conf.d/keymaps)
sys-libs/glibc (/etc/locale.gen)</pre></div>
<p>This tells us that the package sys-libs/glibc owns the /etc/locale.gen configuration file. The bootstrap is going to emerge the glibc, so we will make a backup of the configuration file.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd /usr/portage/scripts # cp -v /etc/local.gen{,.bak}</pre></div>
<p>You may be thinking, &ldquo;We also edited /etc/portage/make.conf why aren&rsquo;t we backing it up?&rdquo; The reasoning behind this is that no package owns that file, meaning it will not be overwritten by executing the bootstrap.sh script. Let&rsquo;s begin the bootstrap:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd /usr/portage/scripts # ./bootstrap.sh</pre></div>
<p>Grab some coffee or tea, because this will take a while; if you wish, you can switch to your second screen (<Ctrl-<Alt>-<f2> or <Ctrl-a><n> if using screen) and watch your system being built.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot:2) livecd / # showem</pre></div>
<p><em>Show screen shots</em></p>

<p>Now that we have rebuilt gcc, we should check its configuration. Issue:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd /usr/portage/scripts # gcc-config --list-profiles</pre></div>
<p>Sometimes upgrading gcc will not work properly; the most likely cause is that the <em>Application Binary Interface</em> (ABI), libtool uses hardcoded gcc version information. <strong>If, and only if, the output tells you the configuration is invalid, issue the following to fix it:</strong></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd /usr/portage/scripts # gcc-config 1
(chroot) livecd /usr/portage/scripts # env-update &amp;&amp; source /etc/profile &amp;&amp; export PS1=&#34;(chroot) $PS1&#34;
(chroot) livecd /usr/portage/scripts # emerge --ask --verbose --oneshot sys-devel/libtool

... additional output suppressed ...
Would you like to merge these packages? [Yes/No] &lt;press y, then Enter&gt;
... additional output suppressed ...</pre></div>
<p>For further reading check out <a href="https://wiki.gentoo.org/wiki/Upgrading_GCC">Upgrading GCC</a>.</p>

<p>Now we run ./bootstrap.sh again, to ensure that everything in the toolchain is rebuilt using the new compiler.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd /usr/portage/scripts # ./bootstrap.sh
 * System has been bootstrapped already!
 * If you re-bootstrap the system, you must complete the entire bootstrap process
 * otherwise you will have a broken system.
 * Press enter to continue or CTRL+C to abort ..
&lt;press Enter&gt;
... additional output suppressed ...</pre></div>
<p>Again you can switch between screens to watch the progress; if you do so, issue:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot:2) livecd / # source /etc/profile &amp;&amp; export PS1=&#34;(chroot:2) $PS1&#34;
(chroot:2) livecd / # showem</pre></div>
<p>After the toolchain bootstrap has completed (for the second time), we are nearly ready to rebuild all of the other binaries using it. First issue:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd /usr/portage/scripts # gcc-config --list-profiles
(chroot) livecd /usr/portage/scripts # mv -v /etc/locale.gen{.bak,}
(chroot) livecd /usr/portage/scripts # locale-gen</pre></div>
<p>Ensure your locale is still set to &lsquo;C&rsquo;</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd /usr/portage/scripts # eselect locale show
LANG variable in profile:
  C</pre></div>
<p>And finally:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd /usr/portage/scripts # cd /</pre></div>
<h3 id="from-stage2-to-stage3">From stage2 to stage3</h3>

<p>Our system could now be considered to be using a stage2 tarball (we have a basic toolchain without any of the really fun binaries). We will now build everything in the <a href="link to @world package set">@world</a> package set. To start, create an empty &lsquo;timestamp&rsquo; file that we&rsquo;ll use as a marker to check that all of our executables and libraries have been rebuilt.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(chroot) livecd / # touch /tmp/prebuild_checkpoint
(chroot) livecd / # emerge --ask --verbose --emptytree --with-bdeps=y @world
... additional output suppressed ...
Would you like to merge these packages? [Yes/No] &lt;press y, then Enter&gt;
... additional output suppressed ...</pre></div>
<p>If emerge complains about kernel flags not being set correctly, ignore it for now. We will build a kernel with the correct flags shortly.</p>

<p><em>Explain emerge parameters</em></p>

                </div>
            </div>
        </div>
    </body>
    <script src="https://nerdrack.com//js/toc.js"></script>

</html>
